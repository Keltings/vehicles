{% extends 'base_with_sidebar.html' %}

{% block title %}Analytics - Vehicle Intelligence{% endblock %}

{% block sidebar %}
<div class="sidebar">
    <div class="sidebar-section">
        <div class="sidebar-title">Analytics</div>
        <a href="{% url 'analytics_overview' %}" class="sidebar-item active">
            <i class="fas fa-chart-line"></i>
            <span>Overview</span>
        </a>
        <a href="{% url 'site_analytics' %}" class="sidebar-item">
            <i class="fas fa-building"></i>
            <span>Sites</span>
        </a>
        <a href="{% url 'time_analytics' %}" class="sidebar-item">
            <i class="fas fa-clock"></i>
            <span>Time & Routes</span>
        </a>
        <a href="{% url 'vehicle_type_analytics' %}" class="sidebar-item">
            <i class="fas fa-car"></i>
            <span>Vehicle Types</span>
        </a>
        <a href="{% url 'duration_analytics' %}" class="sidebar-item">
            <i class="fas fa-hourglass-half"></i>
            <span>Duration</span>
        </a>
        <a href="#" class="sidebar-item">
            <i class="fas fa-map-marked-alt"></i>
            <span>Site Intelligence</span>
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<a href="{% url 'dashboard' %}" class="back-button">
    <i class="fas fa-arrow-left"></i>
    Back to Dashboard
</a>

<div class="page-header">
    <h1 class="page-title">Advanced Analytics</h1>
    <p class="page-subtitle">Comprehensive operational insights across all sites</p>
</div>

<style>
.filters-bar {
    background: var(--bg-darker);
    border: 1px solid rgba(16, 185, 129, 0.2);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 32px;
    display: flex;
    gap: 16px;
    align-items: end;
}

.filter-group {
    flex: 1;
}

.filter-label {
    display: block;
    font-size: 0.85rem;
    color: var(--text-medium);
    margin-bottom: 8px;
    font-weight: 600;
}

.filter-select {
    width: 100%;
    padding: 10px 14px;
    background: var(--bg-dark);
    border: 1px solid rgba(16, 185, 129, 0.3);
    border-radius: 8px;
    color: var(--text-light);
    font-size: 0.95rem;
}

.filter-btn {
    padding: 10px 24px;
    background: var(--primary-green);
    border: none;
    border-radius: 8px;
    color: white;
    font-weight: 600;
    cursor: pointer;
    height: 42px;
}

.stat-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
}

.stat-card {
    background: var(--bg-darker);
    border: 1px solid rgba(16, 185, 129, 0.2);
    border-radius: 16px;
    padding: 24px;
}

.stat-label {
    font-size: 0.8rem;
    color: var(--text-dark);
    text-transform: uppercase;
    margin-bottom: 12px;
}

.stat-value {
    font-size: 2.5rem;
    font-weight: 800;
    color: var(--text-white);
    margin-bottom: 8px;
}

.stat-trend {
    font-size: 0.85rem;
    color: var(--primary-green);
}

.section {
    background: var(--bg-darker);
    border: 1px solid rgba(16, 185, 129, 0.2);
    border-radius: 16px;
    padding: 32px;
    margin-bottom: 32px;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
}

.section-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-white);
}

.export-btn {
    padding: 8px 16px;
    background: transparent;
    border: 1px solid var(--primary-green);
    border-radius: 8px;
    color: var(--primary-green);
    cursor: pointer;
    font-size: 0.9rem;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th {
    background: var(--bg-dark);
    color: var(--text-medium);
    font-size: 0.85rem;
    font-weight: 600;
    text-transform: uppercase;
    padding: 16px;
    text-align: left;
    border-bottom: 2px solid rgba(16, 185, 129, 0.3);
}

.data-table td {
    padding: 16px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    color: var(--text-light);
}

.data-table tr:hover {
    background: rgba(16, 185, 129, 0.05);
}

.badge {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
}

.badge-warning {
    background: rgba(245, 158, 11, 0.2);
    color: #fbbf24;
}

.badge-danger {
    background: rgba(239, 68, 68, 0.2);
    color: #f87171;
}

.insight-box {
    background: rgba(16, 185, 129, 0.1);
    border-left: 4px solid var(--primary-green);
    padding: 16px;
    border-radius: 8px;
    margin-bottom: 24px;
}

.two-column {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 32px;
}
</style>

<!-- FILTERS -->
<form method="get" class="filters-bar">
    <div class="filter-group">
        <label class="filter-label">Date Range</label>
        <select name="date_range" class="filter-select">
            <option value="7" {% if date_range == '7' %}selected{% endif %}>Last 7 Days</option>
            <option value="30" {% if date_range == '30' or not date_range %}selected{% endif %}>Last 30 Days</option>
            <option value="90" {% if date_range == '90' %}selected{% endif %}>Last 90 Days</option>
            <option value="all" {% if date_range == 'all' %}selected{% endif %}>All Time</option>
        </select>
    </div>
    
    <div class="filter-group">
        <label class="filter-label">Site</label>
        <select name="site" class="filter-select">
            <option value="" {% if not selected_site %}selected{% endif %}>All Sites</option>
            {% for site in all_sites %}
            <option value="{{ site }}" {% if selected_site == site %}selected{% endif %}>{{ site }}</option>
            {% endfor %}
        </select>
    </div>
    
    <div class="filter-group">
        <label class="filter-label">Vehicle Type</label>
        <select name="vehicle_type" class="filter-select">
            <option value="" {% if not selected_vehicle_type %}selected{% endif %}>All Types</option>
            {% for vtype in vehicle_types %}
            <option value="{{ vtype }}" {% if selected_vehicle_type == vtype %}selected{% endif %}>{{ vtype }}</option>
            {% endfor %}
        </select>
    </div>
    
    <button type="submit" class="filter-btn">
        <i class="fas fa-filter"></i> Apply
    </button>
</form>

<!-- STAT CARDS -->
<div class="stat-cards">
    <div class="stat-card">
        <div class="stat-label">Unique Vehicles</div>
        <div class="stat-value">{{ unique_vehicles|floatformat:0 }}</div>
        <div class="stat-trend" style="color: var(--primary-green);">
            <i class="fas fa-info-circle"></i> {{ unique_vehicles_context }}
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-label">Cross-Site Movements</div>
        <div class="stat-value" style="color: {% if cross_site_movements > 0 %}var(--primary-green){% else %}var(--text-medium){% endif %};">
            {{ cross_site_movements }}
        </div>
        <div class="stat-trend" style="color: {% if cross_site_movements > 0 %}var(--primary-green){% else %}var(--text-dark){% endif %};">
            <i class="fas fa-arrows-alt"></i> {{ cross_site_context }}
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-label">Avg. Dwell Time</div>
        <div class="stat-value">{{ avg_dwell_time }}</div>
        <div class="stat-trend" style="color: var(--primary-green);">
            <i class="fas fa-clock"></i> {{ dwell_context }}
        </div>
    </div>
    
    <div class="stat-card" style="{% if anomalies > 0 %}border-color: rgba(239, 68, 68, 0.5);{% endif %}">
        <div class="stat-label">Operational Issues</div>
        <div class="stat-value" style="color: {% if anomalies > 0 %}#ef4444{% else %}var(--primary-green){% endif %};">
            {{ anomalies }}
        </div>
        <div class="stat-trend" style="color: {% if anomalies > 0 %}#ef4444{% else %}var(--primary-green){% endif %};">
            <i class="fas fa-{% if anomalies > 0 %}exclamation-triangle{% else %}check-circle{% endif %}"></i> {{ anomaly_context }}
        </div>
    </div>
</div>

<!-- INSIGHTS -->
{% if insights %}
<div class="insight-box">
    <i class="fas fa-lightbulb" style="color: var(--primary-green); margin-right: 8px;"></i>
    <span style="color: var(--text-light); font-size: 0.95rem;"><strong>Key Insight:</strong> {{ insights.0 }}</span>
</div>
{% endif %}

<!-- SITE PERFORMANCE -->
<div class="section">
    <div class="section-header">
        <h2 class="section-title">Site Performance Comparison</h2>
        <button class="export-btn">
            <i class="fas fa-download"></i> Export CSV
        </button>
    </div>
    
    <table class="data-table">
        <thead>
            <tr>
                <th>Site Name</th>
                <th>Total Entries</th>
                <th>Unique Vehicles</th>
                <th>Avg Duration</th>
                <th>Current Occupancy</th>
            </tr>
        </thead>
        <tbody>
            {% for site in site_performance %}
            <tr>
                <td style="font-weight: 600; color: var(--text-white);">{{ site.site_name }}</td>
                <td>{{ site.total_entries }}</td>
                <td>{{ site.unique_vehicles }}</td>
                <td>{{ site.avg_duration }}</td>
                <td>{{ site.current_occupancy }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- TIME & PAYMENT -->
<div class="two-column">
    <div class="section">
        <div class="section-header">
            <h2 class="section-title">Peak Hours</h2>
        </div>
        
        <table class="data-table">
            <thead>
                <tr>
                    <th>Hour</th>
                    <th>Avg Vehicles</th>
                    <th>Peak Day</th>
                </tr>
            </thead>
            <tbody>
                {% for hour in peak_hours %}
                <tr>
                    <td style="font-weight: 600;">{{ hour.hour }}:00</td>
                    <td>{{ hour.avg_count }}</td>
                    <td>{{ hour.peak_day }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <div class="section">
        <div class="section-header">
            <h2 class="section-title">Payment Methods</h2>
        </div>
        
        <div id="paymentPieChart" style="width: 100%; height: 350px;"></div>
    </div>
</div>

<!-- VEHICLE TYPE DISTRIBUTION -->
<div class="section">
    <div class="section-header">
        <h2 class="section-title">Vehicle Type Distribution</h2>
        <button class="export-btn">
            <i class="fas fa-download"></i> Export CSV
        </button>
    </div>
    
    <div style="margin-bottom: 16px; color: var(--text-medium); font-size: 0.9rem;">
        Detailed Breakdown
    </div>
    
    <div style="display: flex; flex-direction: column; gap: 16px;">
        {% for vtype in vehicle_distribution %}
        <div style="display: flex; align-items: center; gap: 16px;">
            <div style="width: 150px; font-weight: 600; color: var(--text-white);">
                {{ vtype.type }}
            </div>
            <div style="flex: 1; background: var(--bg-dark); border-radius: 8px; height: 32px; position: relative; overflow: hidden;">
                <div style="width: {{ vtype.percentage }}%; background: var(--primary-green); height: 100%; border-radius: 8px; transition: width 0.3s ease;"></div>
            </div>
            <div style="width: 180px; display: flex; justify-content: space-between; align-items: center;">
                <span style="color: var(--primary-green); font-weight: 700;">
                    {{ vtype.percentage|floatformat:1 }}% ({{ vtype.count }})
                </span>
                <span style="color: var(--text-medium); font-size: 0.85rem;">
                    {{ vtype.avg_duration }}
                </span>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- FREQUENT ROUTES -->
<div class="section">
    <div class="section-header">
        <h2 class="section-title">{{ routes_title }}</h2>
        <button class="export-btn">
            <i class="fas fa-download"></i> Export CSV
        </button>
    </div>
    
    <table class="data-table">
        <thead>
            <tr>
                <th>Route</th>
                <th>Unique Vehicles</th>
                <th>Total Trips</th>
                <th>Avg Time Between Sites</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for route in frequent_routes %}
            <tr>
                <td style="font-weight: 600;">
                    <i class="fas fa-map-marker-alt" style="color: var(--primary-green); margin-right: 8px;"></i>
                    {{ route.from_site }} 
                    <i class="fas fa-arrow-right" style="color: var(--text-dark); margin: 0 8px;"></i>
                    {{ route.to_site }}
                </td>
                <td>{{ route.unique_vehicles }}</td>
                <td>{{ route.total_trips }}</td>
                <td>{{ route.avg_time_between }}</td>
                <td>
                    <button class="export-btn" style="padding: 4px 12px; font-size: 0.8rem;" onclick="showRouteVehicles('{{ route.from_site }}', '{{ route.to_site }}')">
                        <i class="fas fa-search"></i> View Vehicles
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<!-- OPERATIONAL ISSUES -->
<!-- OPERATIONAL ISSUES -->
<div class="section">
    <div class="section-header">
        <h2 class="section-title">Operational Issues Requiring Attention</h2>
        <div style="display: flex; gap: 12px; align-items: center;">
            <input 
                type="text" 
                id="issuesSearch" 
                placeholder="Search by plate, site, or issue type..."
                style="padding: 8px 16px; background: var(--bg-dark); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; color: var(--text-light); width: 300px;"
                onkeyup="filterIssuesTable()"
            >
            <button class="export-btn">
                <i class="fas fa-download"></i> Export CSV
            </button>
        </div>
    </div>
    
    <table class="data-table">
        <thead>
            <tr>
                <th>Issue Type</th>
                <th>Plate Number</th>
                <th>Site</th>
                <th>Entry Time</th>
                <th>Duration</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="issuesTableBody">
            {% for issue in operational_issues_page %}
            <tr>
                <td><span class="badge badge-{{ issue.severity }}">{{ issue.type }}</span></td>
                <td style="font-weight: 600;">{{ issue.plate }}</td>
                <td>{{ issue.site }}</td>
                <td>{{ issue.entry_time }}</td>
                <td>{{ issue.duration }}</td>
                <td>
                    <button class="export-btn" style="padding: 4px 12px; font-size: 0.8rem;" onclick="investigateVehicle('{{ issue.plate_full }}')">
                        Investigate
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    {% if total_issues > 5 %}
    <div style="display: flex; justify-content: center; align-items: center; gap: 16px; margin-top: 24px;">
        <button onclick="prevPage()" class="export-btn" {% if current_page == 1 %}disabled style="opacity: 0.5;"{% endif %}>
            <i class="fas fa-chevron-left"></i> Previous
        </button>
        <span style="color: var(--text-light);">Page {{ current_page }} of {{ total_pages }}</span>
        <button onclick="nextPage()" class="export-btn" {% if current_page == total_pages %}disabled style="opacity: 0.5;"{% endif %}>
            Next <i class="fas fa-chevron-right"></i>
        </button>
    </div>
    {% endif %}
</div>

<!-- MODAL -->
<div id="investigateModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; align-items: center; justify-content: center;">
    <div style="background: var(--bg-darker); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 20px; max-width: 900px; width: 90%; max-height: 85vh; overflow-y: auto; padding: 32px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <h2 style="font-size: 1.5rem; font-weight: 700; color: var(--text-white);">Vehicle Investigation</h2>
            <button onclick="closeInvestigateModal()" style="background: none; border: none; color: var(--text-dark); font-size: 1.5rem; cursor: pointer;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="investigateContent"></div>
    </div>
</div>
<!-- ROUTE VEHICLES MODAL -->
<div id="routeModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; align-items: center; justify-content: center;">
    <div style="background: var(--bg-darker); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 20px; max-width: 1000px; width: 90%; max-height: 85vh; overflow-y: auto; padding: 32px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
            <h2 style="font-size: 1.5rem; font-weight: 700; color: var(--text-white);" id="routeModalTitle">Route Vehicles</h2>
            <button onclick="closeRouteModal()" style="background: none; border: none; color: var(--text-dark); font-size: 1.5rem; cursor: pointer;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="routeContent">
            <div style="text-align: center; padding: 40px; color: var(--text-dark);">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--primary-green);"></i>
                <p style="margin-top: 16px;">Loading vehicles...</p>
            </div>
        </div>
    </div>
</div>
<script>
// Payment methods pie chart
var paymentData = {{ payment_methods_chart|safe }};
if (paymentData && paymentData.length > 0) {
    var pieTrace = {
        labels: paymentData.map(d => d.method),
        values: paymentData.map(d => d.count),
        type: 'pie',
        marker: {
            colors: ['#10b981', '#34d399', '#6ee7b7', '#a7f3d0', '#d1fae5']
        },
        textinfo: 'label+percent',
        textposition: 'outside',
        automargin: true
    };
    
    Plotly.newPlot('paymentPieChart', [pieTrace], {
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        font: { color: '#cbd5e1', size: 14 },
        showlegend: false,
        margin: { t: 40, b: 40, l: 40, r: 40 }
    }, {responsive: true});
}

// Pagination for operational issues
var currentPage = {{ current_page }};
var totalPages = {{ total_pages }};

function nextPage() {
    if (currentPage < totalPages) {
        var url = new URL(window.location.href);
        url.searchParams.set('issues_page', currentPage + 1);
        window.location.href = url.toString();
    }
}

function prevPage() {
    if (currentPage > 1) {
        var url = new URL(window.location.href);
        url.searchParams.set('issues_page', currentPage - 1);
        window.location.href = url.toString();
    }
}

function investigateVehicle(plateNumber) {
    const modal = document.getElementById('investigateModal');
    const content = document.getElementById('investigateContent');
    
    modal.style.display = 'flex';
    content.innerHTML = '<div style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--primary-green);"></i><p style="margin-top: 16px; color: var(--text-dark);">Loading vehicle details...</p></div>';
    
    fetch('/intelligence/api/vehicle/' + plateNumber + '/')
        .then(response => response.json())
        .then(data => {
            let html = `
            <div style="display: grid; gap: 24px;">
                ${data.is_flagged ? `
                <div style="background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.3); padding: 16px; border-radius: 12px;">
                    <h4 style="color: #f87171; margin-bottom: 8px;"><i class="fas fa-exclamation-triangle"></i> FLAGGED VEHICLE</h4>
                    <p style="color: var(--text-light); margin-bottom: 8px;"><strong>Reason:</strong> ${data.flag_info.reason}</p>
                    <p style="color: var(--text-light); margin-bottom: 8px;"><strong>Priority:</strong> ${data.flag_info.priority}</p>
                    <p style="color: var(--text-light);"><strong>Details:</strong> ${data.flag_info.description}</p>
                </div>
                ` : ''}
                
                <div style="background: var(--bg-dark); padding: 20px; border-radius: 12px;">
                    <h3 style="color: var(--primary-green); margin-bottom: 16px;"><i class="fas fa-car"></i> Vehicle Information</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                        <div><span style="color: var(--text-dark);">Plate:</span> <strong style="color: var(--text-white);">${data.plate_number}</strong></div>
                        <div><span style="color: var(--text-dark);">Type:</span> <strong style="color: var(--text-white);">${data.vehicle_type}</strong></div>
                        <div><span style="color: var(--text-dark);">Brand:</span> <strong style="color: var(--text-white);">${data.vehicle_brand}</strong></div>
                        <div><span style="color: var(--text-dark);">Color:</span> <strong style="color: var(--text-white);">${data.plate_color}</strong></div>
                        <div><span style="color: var(--text-dark);">First Seen:</span> <strong style="color: var(--text-white);">${data.first_seen}</strong></div>
                        <div><span style="color: var(--text-dark);">Last Seen:</span> <strong style="color: var(--text-white);">${data.last_seen}</strong></div>
                    </div>
                </div>
                
                <div style="background: var(--bg-dark); padding: 20px; border-radius: 12px;">
                    <h3 style="color: var(--primary-green); margin-bottom: 16px;"><i class="fas fa-chart-bar"></i> Activity Summary</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                        <div><span style="color: var(--text-dark);">Total Visits:</span> <strong style="color: var(--text-white);">${data.total_visits}</strong></div>
                        <div><span style="color: var(--text-dark);">Sites Visited:</span> <strong style="color: var(--text-white);">${data.sites_visited}</strong></div>
                        <div><span style="color: var(--text-dark);">Most Frequent:</span> <strong style="color: var(--text-white);">${data.most_frequent_site}</strong></div>
                        <div><span style="color: var(--text-dark);">Avg Duration:</span> <strong style="color: var(--text-white);">${data.avg_duration}</strong></div>
                    </div>
                </div>
                
                <div style="background: var(--bg-dark); padding: 20px; border-radius: 12px;">
                    <h3 style="color: var(--primary-green); margin-bottom: 16px;"><i class="fas fa-history"></i> Complete Journey History (${data.visit_history.length} visits)</h3>
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table class="data-table" style="font-size: 0.9rem;">
                            <thead style="position: sticky; top: 0; background: var(--bg-dark); z-index: 10;">
                                <tr>
                                    <th>Site</th>
                                    <th>Entry</th>
                                    <th>Exit</th>
                                    <th>Duration</th>
                                    <th>Amount</th>
                                    <th>Payment</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.visit_history.map(visit => `
                                    <tr>
                                        <td style="font-weight: 600;">${visit.site}</td>
                                        <td>${visit.entry}</td>
                                        <td>${visit.exit}</td>
                                        <td style="color: var(--primary-green);">${visit.duration}</td>
                                        <td>KSh ${visit.amount_paid.toLocaleString()}</td>
                                        <td><span style="padding: 2px 8px; background: rgba(16, 185, 129, 0.2); border-radius: 4px; font-size: 0.8rem;">${visit.payment_method}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            `;
            
            content.innerHTML = html;
        })
        .catch(error => {
            content.innerHTML = '<div style="text-align: center; padding: 40px; color: #f87171;"><i class="fas fa-exclamation-circle" style="font-size: 2rem;"></i><p style="margin-top: 16px;">Error loading vehicle details</p></div>';
            console.error('Error:', error);
        });
}

function closeInvestigateModal() {
    document.getElementById('investigateModal').style.display = 'none';
}
// Route investigation functions
function showRouteVehicles(fromSite, toSite) {
    const modal = document.getElementById('routeModal');
    const title = document.getElementById('routeModalTitle');
    const content = document.getElementById('routeContent');
    
    title.textContent = fromSite + ' â†’ ' + toSite + ' - Vehicles on this Route';
    modal.style.display = 'flex';
    content.innerHTML = '<div style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--primary-green);"></i><p style="margin-top: 16px; color: var(--text-dark);">Loading vehicles...</p></div>';
    
    // Fetch vehicles for this route
    fetch('/intelligence/api/route-vehicles/?from=' + encodeURIComponent(fromSite) + '&to=' + encodeURIComponent(toSite))
        .then(response => response.json())
        .then(data => {
            if (data.vehicles && data.vehicles.length > 0) {
                let html = `
                <div style="margin-bottom: 16px; color: var(--text-medium);">
                    Found ${data.vehicles.length} vehicle(s) that traveled this route
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Plate Number</th>
                            <th>Vehicle Type</th>
                            <th>Trip Count</th>
                            <th>Last Trip</th>
                            <th>Avg Time Between</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                `;
                
                data.vehicles.forEach(function(vehicle) {
                    html += `
                        <tr>
                            <td style="font-weight: 600;">${vehicle.plate}</td>
                            <td>${vehicle.vehicle_type}</td>
                            <td>${vehicle.trip_count}</td>
                            <td>${vehicle.last_trip}</td>
                            <td>${vehicle.avg_time}</td>
                            <td>
                                <button class="export-btn" style="padding: 4px 12px; font-size: 0.8rem;" onclick="investigateVehicle('${vehicle.plate_full}'); closeRouteModal();">
                                    <i class="fas fa-search"></i> Investigate
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                content.innerHTML = html;
            } else {
                content.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-medium);">No vehicles found for this route.</div>';
            }
        })
        .catch(error => {
            content.innerHTML = '<div style="text-align: center; padding: 40px; color: #f87171;"><i class="fas fa-exclamation-circle" style="font-size: 2rem;"></i><p style="margin-top: 16px;">Error loading vehicles</p></div>';
        });
}

function closeRouteModal() {
    document.getElementById('routeModal').style.display = 'none';
}

// Close on outside click
document.getElementById('routeModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeRouteModal();
    }
});
// Search/filter function for operational issues table
function filterIssuesTable() {
    const searchInput = document.getElementById('issuesSearch');
    const filter = searchInput.value.toLowerCase();
    const table = document.getElementById('issuesTableBody');
    const rows = table.getElementsByTagName('tr');
    
    let visibleCount = 0;
    
    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const cells = row.getElementsByTagName('td');
        let found = false;
        
        // Search in: Issue Type, Plate Number, Site
        for (let j = 0; j < 3; j++) {
            if (cells[j]) {
                const cellText = cells[j].textContent || cells[j].innerText;
                if (cellText.toLowerCase().indexOf(filter) > -1) {
                    found = true;
                    break;
                }
            }
        }
        
        if (found) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    }
    
    // Show "no results" message if needed
    const noResultsRow = document.getElementById('noIssuesResult');
    if (noResultsRow) {
        noResultsRow.remove();
    }
    
    if (visibleCount === 0 && filter !== '') {
        const newRow = table.insertRow(0);
        newRow.id = 'noIssuesResult';
        const cell = newRow.insertCell(0);
        cell.colSpan = 6;
        cell.style.textAlign = 'center';
        cell.style.padding = '40px';
        cell.style.color = 'var(--text-dark)';
        cell.innerHTML = '<i class="fas fa-search" style="font-size: 2rem; margin-bottom: 16px; display: block;"></i>No results found for "' + filter + '"';
    }
}
</script>

{% endblock %}